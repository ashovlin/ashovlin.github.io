<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Alex Shovlin</title>
		<meta name="description" content="Alex Shovlin's personal website">
		<link rel="stylesheet" type="text/css" href="/theme/tufte.min.css" />
		<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<div id="container">
<h1 style="display:inline-block; padding-right:12px;">Python Unit Test Timeout</h1> <span>November 2024</span>
<a style="float: right" href="/">Back to home</a>

<p>Recently at work I needed to apply a timeout to a Python unit test. It wasn't a performance-sensitive area, rather we needed to just verify that a regular expression wasn't <a href="https://en.wikipedia.org/wiki/ReDoS">backtracking exponentially</a>.</p>
<p><a href="https://stackoverflow.com/questions/19527320/how-can-i-limit-the-maximum-running-time-for-a-unit-test">StackOverflow</a> led me to <a href="https://pypi.org/project/pytest-timeout/">pytest-timeout</a>, but I was looking for a way to do this without introducing a new dependency.</p>
<p>Python's <code>signal</code> offers a way to request that our thread will receive a signal in a specified number of seconds, as well as define the handler that is invoked when that signal is received. </p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">test_with_timeout</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fails if it takes longer than 5 seconds.&quot;&quot;&quot;</span>

<span class="w">    </span><span class="c1"># Map SIGALRM to the handler defined below</span>
<span class="w">    </span><span class="k">signal</span><span class="o">.</span><span class="k">signal</span><span class="p">(</span><span class="k">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span><span class="w"> </span><span class="n">handle_timeout</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># Ensure we don&#39;t spend more than 5 seconds on the work</span>
<span class="w">    </span><span class="k">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># Do the work</span>

<span class="w">    </span><span class="c1"># Cancel the scheduled alarm</span>
<span class="w">    </span><span class="k">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">def</span><span class="w"> </span><span class="n">handle_timeout</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raises an error that will cause a test to fail.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">raise</span><span class="w"> </span><span class="n">TimeoutError</span><span class="p">(</span><span class="s1">&#39;Test timed out&#39;</span><span class="p">)</span>
</code></pre></div>

<p>A caveat is that <code>signal.SIGALRM</code> is only <a href="https://docs.python.org/3/library/intro.html#availability">available</a> on Unix systems (which includes MacOS), so if you're running tests on Windows </p>
<a href="/">Back to home</a>
		</div>
		<script src="https://getinsights.io/static/js/insights.js"></script>
		<script>
			insights.init('OCH9z9Pz5NcP2Gmx');
			insights.trackPages();
		</script>
	</body>
</html>